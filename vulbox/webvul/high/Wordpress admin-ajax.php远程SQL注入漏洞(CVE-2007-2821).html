
<!DOCTYPE html>

<html>

	<head>

		<meta charset="utf-8">

        <link rel="stylesheet" href="/vulbox/source/table.css" />

	</head>

	<body class="dialog">

		<div class="content">

			<div class="wrap">

				<div class="cont">

					<table class="table table-hover table-mc-light-blue" style="margin-top: 0;">

						<thead>

							<tr class="first_title">

								<th colspan="2">漏洞描述</th>

							</tr>

						</thead>

						<tbody>

							<tr>

								<th width="70">漏洞名称</th>

								<td>

								    <img style="float:left;" src="/vulbox/source/h.gif" align="absmiddle"/>

								<span style="float:left;margin-top:1px;margin-top:2px\9;">Wordpress admin-ajax.php远程SQL注入漏洞(CVE-2007-2821)</span>

								</td>

							</tr>

							<tr>

								<th valign="top">详细描述</th>

								<td valign="top">

									WordPress是一款免费的论坛Blog系统。
<br />

<br />

									WordPress实现上存在输入验证漏洞，远程攻击者可能利用此漏洞执行SQL注入攻击非授权访问数据库。
<br />

<br />

									WordPress的wp-admin/admin-ajax.php文件没有正确验证对cookie参数的输入。在wp-admin/admin-ajax.php的6行：
<br />

<br />

									------------------[source code]----------------------
<br />

									define(&#39;DOING_AJAX&#39;, true);
<br />

<br />

									check_ajax_referer();
<br />

									if ( !is_user_logged_in() )
<br />

									die(&#39;-1&#39;);
<br />

									------------------[/source code]----------------------
<br />

<br />

									然后在check_ajax_referer()函数中：
<br />

<br />

									------------------[source code]----------------------
<br />

									function check_ajax_referer() {
<br />

									$cookie = explode(&#39;; &#39;, urldecode(empty($_POST[&#39;cookie&#39;]) ?
<br />

									$_GET[&#39;cookie&#39;] : $_POST[&#39;cookie&#39;])); // AJAX scripts must pass
<br />

									cookie=document.cookie
<br />

									foreach ( $cookie as $tasty ) {
<br />

									if ( false !== strpos($tasty, USER_COOKIE) )
<br />

									$user = substr(strstr($tasty, &#39;=&#39;), 1);
<br />

									if ( false !== strpos($tasty, PASS_COOKIE) )
<br />

									$pass = substr(strstr($tasty, &#39;=&#39;), 1);
<br />

									}
<br />

									if ( !wp_login( $user, $pass, true ) )
<br />

									die(&#39;-1&#39;);
<br />

									------------------[/source code]----------------------
<br />

<br />

									可见使用了urldecode()，因此通过%2527就可以向wp_login()传送单引号，绕过php的magic_quotes功能。
<br />

<br />

									接下来：
<br />

<br />

									------------------[source code]----------------------
<br />

									function wp_login($username, $password, $already_md5 = false) {
<br />

									global $wpdb, $error;
<br />

									...
<br />

									$login = get_userdatabylogin($username);
<br />

									------------------[/source code]----------------------
<br />

<br />

									最终：
<br />

<br />

									------------------[source code]----------------------
<br />

									function get_userdatabylogin($user_login) {
<br />

									global $wpdb;
<br />

									...
<br />

									if ( !$user = $wpdb-&gt;get_row(&quot;SELECT * FROM $wpdb-&gt;users
<br />

									WHERE user_login = &#39;$user_login&#39;&quot;) )
<br />

									return false;
<br />

									------------------[/source code]----------------------
<br />

<br />

									因此攻击者可以执行SQL注入攻击。<br />

								</td>

							</tr>

							<tr>

								<th  valign="top">解决方案</th>

								<td valign="top">

									WordPress<br />

									---------<br />

									目前厂商已经发布了升级补丁以修复这个安全问题，请到厂商的主页下载：
<br />

<br />

									http://wordpress.org/download/<br />

								</td>

							</tr>

							<tr>

								<th>威胁分值</th>

								<td>7</td>

							</tr>

							<tr>

								<th>危险插件</th>

								<td>否</td>

							</tr>

							<tr>

                                <th>发现日期</th>

                                <td>2007-05-22</td>

                            </tr>

							<tr>

                                <th>发布日期</th>

                                <td>2014-04-16</td>

                            </tr>

							<tr>

								<th>CVE</th>

								<td>

									<a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2007-2821" target="_blank">CVE-2007-2821</a>&nbsp;

								</td>

							</tr>

							<tr>

								<th>BUGTRAQ</th>

								<td>

									<a href="http://www.securityfocus.com/bid/24076" target="_blank">24076</a>

								</td>

							</tr>

							<tr>

								<th>NSFOCUS</th>

								<td>

									<a href="http://www.nsfocus.net/index.php?act=sec_bug&do=view&bug_id=10375" target="_blank">10375</a>

								</td>

							</tr>

							<tr>

								<th>CNNVD编号</th>

								<td>

									CNNVD-200705-427&nbsp;&nbsp;

								</td>

							</tr>

							<tr>

								<th>CNCVE编号</th>

								<td>

									CNCVE-20072821&nbsp;&nbsp;

								</td>

							</tr>

							<tr>

								<th>CVSS评分</th>

								<td>

									7.5&nbsp;&nbsp;

								</td>

							</tr>

							<tr>

								<th>CNVD编号</th>

								<td>

									CNVD-2009-10375&nbsp;&nbsp;

								</td>

							</tr>

						</tbody>

					</table>

				</div>

			</div>

		</div>

	</body>

</html>